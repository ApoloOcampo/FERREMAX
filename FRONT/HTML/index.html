<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Venta</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- CSS -->
    <link href="../CSS/style.css" rel="stylesheet" />
    <!-- JS -->
    <link href="../JS/alerts.js" rel="stylesheet" />
    <!-- SWEET ALERT -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <img src="https://www.ferremax.cl/storage/2022/01/Group-34.png" class="img-header" alt="logo">

    <div class="container mt-2">
        <div class="row justify-content-md-center">
            <div class="col-sm-8 ">
                <div class="card">
                    <div class="card-body">
                        <h2 class="card-title justify-content-md-center">VENTA DE PRODUCTOS</h2>

                        <div class="form-row" novalidate>
                            <br>
                            <div class="row">
                                <h5 class="card-title justify-content-md-center" style="color: #dadada;">DATOS CLIENTE</h5>
                                <div class="col-25">
                                    <label for="cboCliente" style="color: #ffffff;"><b>CLIENTE</b></label>
                                </div>
                                <div class="col-75">
                                    <select id="cboCliente" name="cboCliente" required>
                                    </select>
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <h5 class="card-title justify-content-md-center" style="color: #dadada;">DATOS DE PRODUCTO</h5>
                                <div class="col-25">
                                    <label for="cboProducto" style="color: #ffffff;"><b>PRODUCTO</b></label>
                                </div>
                                <div class="col-75">
                                    <select id="cboProducto" name="cboProducto" required>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-25">
                                    <label for="txtCantidad" style="color: #ffffff;"><b>CANTIDAD</b></label>
                                </div>
                                <div class="col-75">
                                    <input type="number" min="1" id="txtCantidad" name="txtCantidad"
                                        placeholder="Ingrese la cantidad..." required>
                                </div>
                            </div>

                            <br>

                            <div class="d-flex justify-content-md-end">
                                <button class="button-cancelar" id="btnCancelar" role="button">CANCELAR</button>
                                <button class="button-aceptar" id="btnAceptar" type="submit" role="button">ACEPTAR</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Carrito de compras -->
                <div class="card mt-3">
                    <div class="card-body">
                        <h5 class="card-title">Carrito de Compras</h5>
                        <ul id="carrito" class="list-group">
                            <!-- Items del carrito -->
                        </ul>
                        <div class="mt-3">
                            <h6>Total: $<span id="total">0.00</span></h6>
                        </div>
                        <div class="d-flex justify-content-md-end">
                            <button class="button-comprar" id="btnComprar" role="button">COMPRAR</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>

<!-- SCRIPT -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
    integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
    crossorigin="anonymous"></script>

<script type="text/javascript">
    const cboCliente = document.getElementById('cboCliente');
    const cboProducto = document.getElementById('cboProducto');
    const listaClientes = fetch("http://localhost:5000/api/cliente", {
        headers: {
            "Content-Type": "application/json",
            "Access-Control-Allow-Origin": "*",
        },
        mode: 'cors'
    });
    const listaProductos = fetch("http://localhost:5000/api/producto", {
        headers: {
            "Content-Type": "application/json",
            "Access-Control-Allow-Origin": "*",
        },
        mode: 'cors'
    });

    listaClientes.then(async function(e){
        await e.json().then(async function(objeto){
            let itemsStr = "";
            objeto.forEach(element => {
                itemsStr += "<option value='"+ element.id +"'>" + element.razonSocial + "</option>";
            });
            cboCliente.innerHTML = itemsStr;
        });
    });
    listaProductos.then(async function(e){
        await e.json().then(async function(objeto){
            let itemsStr = "";
            objeto.forEach(element => {
                itemsStr += "<option value='"+ element.id +"'>" + element.nombre + "</option>";
            });
            cboProducto.innerHTML = itemsStr;
        });
    }).catch(function(error){
        alert(error.message);
    }).finally(() => {
        console.log("Termino el proceso del fetch a clientes");
    });

    function updateCartUI(cart) {
        const carrito = document.getElementById('carrito');
        const total = document.getElementById('total');
        carrito.innerHTML = '';
        let totalPrice = 0;
        cart.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.textContent = `${item.nombre} - ${item.cantidad} unidades`;

            const button = document.createElement('button');
            button.className = 'btn btn-danger btn-sm';
            button.textContent = 'Eliminar';
            button.onclick = () => removeItemFromCart(index);

            li.appendChild(button);
            carrito.appendChild(li);
            totalPrice += item.precio * item.cantidad;
        });
        total.textContent = totalPrice.toFixed(2);
    }

    function clickEnviar(e) {
        e.preventDefault();
        const idCliente = document.getElementById("cboCliente").value;
        const idProducto = document.getElementById("cboProducto").value;
        const cantidad = document.getElementById("txtCantidad").value;

        if (cantidad < 1) {
            Swal.fire({
                position: "top-end",
                icon: "error",
                title: "La cantidad debe ser al menos 1",
                showConfirmButton: false,
                timer: 1500
            });
            return;
        }

        fetch(`http://localhost:5000/api/producto/${idProducto}`, {
            headers: {
                "Content-Type": "application/json",
                "Access-Control-Allow-Origin": "*",
            },
            mode: 'cors'
        }).then(async function(e){
            if (e.status === 200) {
                await e.json().then((producto) => {
                    let cart = JSON.parse(localStorage.getItem(`cart_${idCliente}`)) || [];
                    cart.push({ ...producto, cantidad: parseInt(cantidad) });
                    localStorage.setItem(`cart_${idCliente}`, JSON.stringify(cart));
                    updateCartUI(cart);
                    Swal.fire({
                        position: "top-end",
                        icon: "success",
                        title: "Producto agregado con éxito al carrito!",
                        showConfirmButton: false,
                        timer: 1500
                    });
                });
            } else {
                Swal.fire({
                    position: "top-end",
                    icon: "error",
                    title: `Error al obtener el producto. Código de estado: ${e.status}`,
                    showConfirmButton: true,
                });
            }
        }).catch(function(error){ 
            Swal.fire({
                position: "top-end",
                icon: "error",
                title: `Error: ${error.message}`,
                showConfirmButton: false,
                timer: 1500
            });
        });
    }

    function removeItemFromCart(index) {
        const idCliente = document.getElementById("cboCliente").value;
        let cart = JSON.parse(localStorage.getItem(`cart_${idCliente}`)) || [];
        cart.splice(index, 1);
        localStorage.setItem(`cart_${idCliente}`, JSON.stringify(cart));
        updateCartUI(cart);
        Swal.fire({
            position: "top-end",
            icon: "success",
            title: "Producto eliminado del carrito!",
            showConfirmButton: false,
            timer: 1500
        });
    }

    const btnAceptar = document.getElementById('btnAceptar');
    btnAceptar.addEventListener("click", clickEnviar);

    const btnComprar = document.getElementById('btnComprar');
    btnComprar.addEventListener("click", function() {
        const idCliente = document.getElementById("cboCliente").value;
        const cart = JSON.parse(localStorage.getItem(`cart_${idCliente}`)) || [];
        if (cart.length === 0) {
            Swal.fire({
                position: "top-end",
                icon: "error",
                title: "El carrito está vacío!",
                showConfirmButton: false,
                timer: 1500
            });
            return;
        }

        const objEnvio = {
            "id_cliente": idCliente,
            "productos": cart.map(item => ({
                "id_producto": item.id,
                "cantidad": item.cantidad
            }))
        };

        fetch("http://localhost:5001/api/boleta", {
            headers: {
                "Content-Type": "application/json",
                "Access-Control-Allow-Origin": "*",
            },
            mode: 'cors',
            method: 'POST',
            body: JSON.stringify(objEnvio)
        }).then(async function(e){
            if (e.status === 201) {
                await e.json().then((obj) => {
                    console.log({obj});
                    localStorage.removeItem(`cart_${idCliente}`);
                    updateCartUI([]);
                    Swal.fire({
                        position: "top-end",
                        icon: "success",
                        title: "Compra realizada con éxito!",
                        showConfirmButton: false,
                        timer: 1500
                    });
                });
            } else {
                Swal.fire({
                    position: "top-end",
                    icon: "error",
                    title: `Error al realizar la compra. Código de estado: ${e.status}`,
                    showConfirmButton: true,
                });
            }
        }).catch(function(error){ 
            Swal.fire({
                position: "top-end",
                icon: "error",
                title: `Error: ${error.message}`,
                showConfirmButton: false,
                timer: 1500
            });
        });
    });

    document.getElementById('cboCliente').addEventListener('change', function() {
        const idCliente = this.value;
        const cart = JSON.parse(localStorage.getItem(`cart_${idCliente}`)) || [];
        updateCartUI(cart);
    });

    window.addEventListener('load', function() {
        const idCliente = document.getElementById('cboCliente').value;
        const cart = JSON.parse(localStorage.getItem(`cart_${idCliente}`)) || [];
        updateCartUI(cart);
    });
</script>

</html>
